---
title: "Actividad Final"
output: pdf_notebook
---

```{r}
rm(list=ls());
options(stringAsFactors = FALSE);
```

```{r}
library("gplots"); # heatmap.2()

```

```{r}
# Función para cálculo de diferencia de prueba t student.
t_student_diff <- function(df, index_list_a, index_list_b, col_names =  c("Tumor", "Normal", "Diff")) {
  res <- t(apply(df, 1, 
      function(x) {
        m_1 <- mean(x[index_list_a], na.rm = TRUE);
        m_2 <- mean(x[index_list_b], na.rm = TRUE);
        m_diff <- abs(m_1 - m_2);
        c(m_1, m_2, m_diff);
      }));
  colnames(res) <- col_names;
  return(res);
};

# Función para cálculo de diferencia de prueba t student para dataframes con esquema de clases.
t_student_classes <- function(df, classes, cr_a, cr_b, col_names = c("A", "B", "p_value", "fold_change")){
  samples_a <- which(classes == cr_a);
  samples_b <- which(classes == cr_b);  
  t_res <- t(apply(df, 1, 
          function(x){
            t_test <- t.test(x[samples_a], x[samples_b]);
            c(t_test$estimate[1], t_test$estimate[2], t_test$p.value, t_test$estimate[1] - t_test$estimate[2]);
          }));
    colnames(t_res) <- col_names;
    return(t_res);
};

# Regresa un dataframe con los primeros n resultados ordenados por la columna col.
get_top_n <- function(df, col, n, decreasing = FALSE){
  return(head(df[order(col, decreasing=decreasing),],n));
};

```

## Análisis de Multi_Cancer_Data

```{r}
  load("Multi_Cancer_Data.Rdata");
  df <- multi_cancer_data;
  rm(multi_cancer_data);

  print(head(df, 1));
```

### Diferenia entre muestras normales y muestras de cáncer color

```{r}
# Selección de muestras normales.
normal_samples_indexes <- grep("Normal", colnames(df));
print(normal_samples_indexes);

# Selección de muestras de cáncer colorrectal.
colorectal_cancer_indexes <- grep("Tumor__Colorectal", colnames(df));
print(colorectal_cancer_indexes);

# Prueba t student.
tstudent_normal_with_colorectal <- data.frame(t_student_diff(df, normal_samples_indexes, colorectal_cancer_indexes,));

# Seleccionar 10 entradas con mayor diferencia.
tstudent_normal_with_colorectal <- get_top_n(tstudent_normal_with_colorectal, tstudent_normal_with_colorectal$Diff, 10, decreasing=TRUE);

print(tstudent_normal_with_colorectal);
```

## Análisis de TCGA_COADREAD_comp_data

```{r}
rm(list=setdiff(ls(), lsf.str()));
load("TCGA_COADREAD_comp_data.RData");
df <- tcga_coadread;
rm(tcga_coadread);
```

### Diferencia entre jóvenes y adultos

```{r}
# Prueba de t student para TCGA COARDREAD por las clases Young  y Old.
tcga_t_test <- t_student_classes(df,tcga_coadread_class,"Young","Old",c("Young", "Old", "p_value", "Fold-Change"));

# Filtración de datos para eliminar entradas no significativas.
tcga_t_test_filter <- apply(tcga_t_test[,1:2],1,function(x){all(x<1)});
tcga_t_test <- tcga_t_test[-which(tcga_t_test_filter),];

# Ordenar por diferencia.
tcga_t_test <- tcga_t_test[order(tcga_t_test[,4], decreasing=TRUE),];

# Genes con mayor diferencia de expresión entre jóvenes y ancianos.
print("# Genes con mayor diferencia de expresión entre jóvenes y ancianos:");
write.table(rownames(tcga_t_test[which(tcga_t_test[,4] > 0),])[1:20], sep='\t', quote=F, row.names=F, col.names=F);
```
```{r}
# Normalización de genes seleccionados.
selected_genes <- rownames(tcga_t_test)[1:20];
aux_mat <- tcga_t_test[selected_genes,];
aux_mat <- t(apply(aux_mat, 1, scale));
colnames(aux_mat) <- colnames(tcga_t_test);
aux_mat <- aux_mat[,-(3:4),drop=FALSE];

num_colors = 128;


# Construcción de mapa de calor.
colors_h <- colorRampPalette(c("darkBlue", "white", "darkred"))(num_colors);
h_breaks <- seq(from=-2, to=2, length=num_colors+1);

heatmap.2(aux_mat, col=colors_h, trace="none", breaks=h_breaks);
```


